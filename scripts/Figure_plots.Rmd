---
title: "Figure_Plots.R"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load libraries}
library(here)
library(data.table)
library(rgdal, quietly = TRUE)
library(ggplot2)
library(MASS)
library(rgeos)
library(latex2exp)
library(sp)
library(raster)
library(viridis)
```

Producing plots and maps, for the Bioko Island Malaria Journal paper:

# Figure 1

```{r BI Map admins}
# Load in Carlos's island outline
bi.outline <- raster::shapefile(here("data/clean/BI_maps/bioko/bioko_admin1.shp"))

areasf <- raster::shapefile(here("data/clean/BI_maps/areas_inh/areas_inh.shp"))
areasf <- fortify(areasf, region = "areaId")
# Here's where we generate the template for making island plots
p1 = ggplot(data = areasf, aes(x=long, y=lat, group = group))
p2 = p1 + geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), 
                       color = "black", fill="grey", size = 0.25)

# higher level admin units
ad2 <- raster::shapefile(here("data/clean/BI_maps/ad2EG/ad2_eg.shp"))
ad2 <- subset(ad2, admin2 %in% c("Malabo", "Riaba", "Luba", "Baney"))
ad4 <- raster::shapefile(here("data/clean/BI_maps/admin4shp/admin4V19.shp"))
ad4.sub <- subset(ad4, admin4 %in% c("Ureka", "Moka Malabo"))

# Load in centroids
bi.centroids <- fread(here("data/clean/pfpr_draws.csv"))
bi.centroids <- bi.centroids[,c("map.area", "utm.x", "utm.y")]

#plot(bi.outline)
```


# Figure 1a: map of the island
```{r Map of island}
admin_map <- p2 + 
  geom_path(data = ad2) +
  geom_path(data = ad4.sub) + theme(aspect.ratio = 1, 
  panel.background = element_rect(fill = "white", colour = "white"),
  axis.text = element_blank(),
  axis.title = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "none")

# ggsave(here("Figures/Figure_1a_admin_outlines.pdf"), 
#        plot = admin_map,
#        width = 6, height = 6, units = "in"
#       )
```

# Figure 1b: population map

```{r Population raster}
pop.data <- fread(here("data/clean/aggregated_2015_2018_travel_data.csv"))

areas.inh <- merge(bi.centroids, pop.data[year == 2018, .(map.area, ad2, pop)], by = "map.area", all = FALSE)

# Look! It's a beautiful population plot!
example.plot <- ggplot()  +
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), 
               color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = data.frame(areas.inh),
             mapping = aes(x = utm.x, y = utm.y, color = log10(pop)), 
             shape = 15, size = 2.1) + 
  scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4", 
                       breaks = c(0,1,2,3,4), 
                       labels = c(expression(1), 10, bquote(10^2), bquote(10^3), bquote(10^4))) +
  #scale_color_viridis(name="Log(Population)", limits=c(0, 5), option="plasma") + # set scale bar parameters
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.2, .8),
        legend.key.size = unit(.35,"inches"))
example.plot

# ggsave(here("Figures/Figure_1b_population_raster.pdf"), 
#        plot = example.plot,
#        width = 6, height = 6, units = "in"
#       )

```

# Figure 1c: RDT results

```{r Survey coverage data}
survey.2015.2018 <- fread(here("data/clean/survey_rdt_aggregated.csv"))
```

```{r RDT collection map}
areas.inh <- merge(areas.inh,
                   survey.2015.2018[,.(map.area, pr)],
                   by = "map.area")

rdt.plot <- ggplot() + 
    geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), 
               color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = data.frame(areas.inh), mapping = aes(x = utm.x, y = utm.y, color = pr), 
             shape = 15, size = 2.1) + 
  scale_color_gradient(name="2015-2018\nRDT PfPR",
                      low="yellow", high="red",
                      limits=c(0, .50),
                      breaks = c(0,.25, .50),
                      na.value = "#606060") + #,
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.2, .78),
        legend.key.size = unit(.35,"inches"))
rdt.plot

# ggsave(here("Figures/Figure_1c_rdt_raster.pdf"), 
#        plot = rdt.plot,
#        width = 6, height = 6, units = "in"
#       )

```

# Figure 1d: MAP estimates
```{r pfpr map}
pfpr.data <- fread(here("data/clean/pfpr_draws.csv"))

pfpr.data <- merge(pop.data[year == 2018,.(map.area, pop)],
      pfpr.data[,.(map.area, pfpr = draw.mean)],
      by = "map.area")

areas.inh <- merge(bi.centroids, pfpr.data, 
                   by = "map.area", all = FALSE)


pfpr.plot <- ggplot() + 
    geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), 
               color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = data.frame(areas.inh), 
             mapping = aes(x = utm.x, y = utm.y, color = pfpr), 
             shape = 15, size = 2.1) + 
  scale_color_gradient(name="Mean PfPR",
                      low="yellow", high="red", limits=c(0, .45)) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.2, .8),
        legend.key.size = unit(.35,"inches"))
pfpr.plot

# ggsave(here("Figures/Figure_1d_pfpr_raster.pdf"), 
#        plot = pfpr.plot,
#        width = 6, height = 6, units = "in"
#       )
```

# Figure 3 - Travel Cases and Local Cases

```{r Travel Fraction}
baseline.means <- fread(here("data/simulation_outputs/simulations_for_figures/baseline_pr_means.csv"))
travelfrac.means <- fread(here("data/simulation_outputs/simulations_for_figures/travelfrac_pr_means.csv"))

tf.dat <- merge(baseline.means[,.(map.area, time, i.base = i)], 
                travelfrac.means[,.(map.area, time, i.trav = i)], 
                by = c("map.area", "time"))

areas.inh <- merge(bi.centroids, pop.data[year == 2018, .(map.area, ad2, pop)], 
                   by = "map.area", all = FALSE)
areas.inh <- as.data.table(areas.inh)
areas.inh[, travel.fraction := NULL]
areas.inh <- merge(areas.inh,
                   tf.dat[time > 1000, .(travel.fraction = mean(i.trav)/mean(i.base)), by = "map.area"],
                   by = "map.area")
areas.inh[, travel.fraction := min(travel.fraction, .5), by = "map.area"]

# Make the map
travel.fraction.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = utm.x, y = utm.y, color = 100*travel.fraction), 
             shape = 15, size = 2.1) + 
  scale_color_viridis(name="Travel Fraction (%)",
                      option="cividis", limits=c(0, 50),
                      breaks = c(0,10,20,30,40, 50),
                      labels = c("0", "10", "20", "30", "40", bquote(">= 50"))) + 
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.25, .8),
        legend.key.size = unit(.35,"inches"))
travel.fraction.plot

# ggsave(here("Figures/Figure_3a_travel_fraction.pdf"), 
#        plot = travel.fraction.plot,
#        width = 6, height = 6, units = "in"
#       )
```


```{r Travel Fraction Error bars}
baseline.means <- fread(here("data/simulation_outputs/simulations_for_figures/baseline_pr_means.csv"))
baseline.sds <- fread(here("data/simulation_outputs/simulations_for_figures/baseline_pr_sds.csv"))
travelfrac.means <- fread(here("data/simulation_outputs/simulations_for_figures/travelfrac_pr_means.csv"))
travelfrac.sds <- fread(here("data/simulation_outputs/simulations_for_figures/travelfrac_pr_sds.csv"))

tf.dat <- merge(travelfrac.means[,.(map.area, time, tf.mean = i)],
                travelfrac.sds[,.(map.area, time, tf.sd = i)],
                by = c("map.area", "time"))

areas.inh <- merge(bi.centroids, pop.data[year == 2018, .(map.area, ad2, pop)], 
                   by = "map.area", all = FALSE)
areas.inh <- as.data.table(areas.inh)
areas.inh[, travel.fraction := NULL]
areas.inh <- merge(areas.inh,
                   tf.dat[time > 1000, .(tf.sd.ratio = mean(tf.sd)/mean(tf.mean)), by = "map.area"],
                   by = "map.area")
areas.inh[, tf.sd.ratio := min(tf.sd.ratio, 2), by = "map.area"]

# Make the map
travel.fraction.errors.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = utm.x, y = utm.y, color = tf.sd.ratio), 
             shape = 15, size = 2.1) + 
  # scale_color_viridis(name="Travel Fraction", option="cividis") +
  scale_color_viridis(name="Travel Fraction\nUncertainty",
                      option="cividis", limits=c(0, 2),
                      breaks = c(0,.5,1,1.5,2),
                      labels = c("0", "0.5", "1", "1.5", bquote(">= 2"))) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.25, .8),
        legend.key.size = unit(.35,"inches"))
travel.fraction.errors.plot

# ggsave(here("Figures/Figure_3c_travel_fraction_variance.pdf"),
#        plot = travel.fraction.errors.plot,
#        width = 6, height = 6, units = "in"
#       )
```


```{r Local Residual Fraction}
baseline.means <- fread(here("data/simulation_outputs/simulations_for_figures/baseline_pr_means.csv"))
localresid.means <- fread(here("data/simulation_outputs/simulations_for_figures/localresid_pr_means.csv"))

lr.dat <- merge(baseline.means[,.(map.area, time, i.base = i)], 
                localresid.means[,.(map.area, time, i.lr = i)], 
                by = c("map.area", "time"))

areas.inh[, local.resid := NULL]
areas.inh <- merge(areas.inh,
                   lr.dat[time > 1000, .(local.resid = mean(i.lr)/mean(i.base)), by = "map.area"],
                   by = "map.area")

# Make the map
local.resid.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = utm.x, y = utm.y, color = 100*local.resid), 
             shape = 15, size = 2.1) + 
  scale_color_viridis(name="Local Residual\nFraction (%)",
                      option = "plasma", limits=c(0, 100),
                      breaks = c(0, 25, 50, 75, 100) ,
                      labels = c("0", "25", "50", "75", "100")) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.25, .78),
        legend.key.size = unit(.35,"inches"))
local.resid.plot

# ggsave(here("Figures/Figure_3b_local_residual_fraction.pdf"), 
#        plot = local.resid.plot,
#        width = 6, height = 6, units = "in"
#       )
```



```{r Local Residual Fraction Error bars}
baseline.means <- fread(here("data/simulation_outputs/simulation_for_figures/baseline_pr_means.csv"))
baseline.sds <- fread(here("data/simulation_outputs/simulation_for_figures/baseline_pr_sds.csv"))
localresid.means <- fread(here("data/simulation_outputs/simulations_for_figures/localresid_pr_means.csv"))
localresid.sds <- fread(here("data/simulation_outputs/simulations_for_figures/localresid_pr_sds.csv"))

lr.dat <- merge(localresid.means[,.(map.area, time, lr.mean = i)],
                localresid.sds[,.(map.area, time, lr.sd = i)],
                by = c("map.area", "time"))

areas.inh <- merge(bi.centroids, pop.data[year == 2018, .(map.area, ad2, pop)], 
                   by = "map.area", all = FALSE)
areas.inh <- as.data.table(areas.inh)
areas.inh[, lr := NULL]
areas.inh <- merge(areas.inh,
                   lr.dat[time > 1000, .(lr.sd.ratio = mean(lr.sd)/mean(lr.mean)), by = "map.area"],
                   by = "map.area")
# I checked: this area has zero prevalence in the sims, and pop=1
areas.inh[map.area==219]$lr.sd.ratio <- 2
areas.inh[, lr.sd.ratio := min(lr.sd.ratio, 2), by = "map.area"]


# Make the map
lr.errors.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = utm.x, y = utm.y, color = lr.sd.ratio), 
             shape = 15, size = 2.1) + 
  #scale_color_viridis(name="Local Residual", option="cividis") +
  scale_color_viridis(name="Local Residual Fraction\nUncertainty",
                      option = "plasma", limits=c(0, 2),
                      breaks = c(0, .5, 1, 1.5, 2),
                      labels = c("0", "0.5", "1", "1.5", bquote(">= 2"))) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.25, .8),
        legend.key.size = unit(.35,"inches"))

lr.errors.plot

# ggsave(here("Figures/Figure_3d_local_residual_fraction_variance.pdf"),
#        plot = lr.errors.plot,
#        width = 6, height = 6, units = "in"
#       )
```

# Figure 4 - Time Series

## Baseline time series
```{r Baseline}
baseline.means <- fread(here("data/simulation_outputs/simulations_for_figures/baseline_pr_means_time_series.csv"))
baseline.sds <- fread(here("data/simulation_outputs/simulations_for_figures/baseline_pr_sds_time_series.csv"))

h <- melt(baseline.means,
          id.vars = c("time", "map.area"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(baseline.sds,
             id.vars = c("time", "map.area"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
baseline.dat <- merge(h, h.sd, by = c("time", "map.area", "variable"))

baseline.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("map.area", "variable", "time")]

```

```{r Baseline Area 73}
baseline.plot.73 <- ggplot(
  data = baseline.dat[map.area == 73 & variable == "i" & time > 365*2]) + # time %in% seq(365, 2554, by = 14) # if we want to do biweekly PR reports
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#EE0800") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*3, 365*4, 365*5, 365*6 ), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

baseline.plot.73

# ggsave(here("Figures/timeseries_baseline_73.pdf"),
#        plot = baseline.plot.73,
#        width = 6, height = 4.5, units = "in"
#       )
```

```{r Baseline Area 1509}
baseline.plot.1509 <- ggplot(
  data = baseline.dat[map.area == 1509 & variable == "i" & time > 365*2]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#CC006A") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*3, 365*4, 365*5, 365*6 ), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
baseline.plot.1509

# ggsave(here("Figures/timeseries_baseline_1509.pdf"),
#        plot = baseline.plot.1509,
#        width = 6, height = 4.5, units = "in"
#       )
```


## Vaccination time series
```{r Vaccine}
vaccine.means <- fread(here("data/simulation_outputs/simulations_for_figures/vaccine_pr_means_time_series.csv"))
vaccine.sds <- fread(here("data/simulation_outputs/simulations_for_figures/vaccine_pr_sds_time_series.csv"))

h <- melt(vaccine.means,
          id.vars = c("time", "map.area"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(vaccine.sds,
             id.vars = c("time", "map.area"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
vaccine.dat <- merge(h, h.sd, by = c("time", "map.area", "variable"))

vaccine.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("map.area", "variable", "time")]
```

```{r Vaccine Map Area 73}
vaccine.plot.73 <- ggplot(
  data = vaccine.dat[map.area == 73 & variable == "i" & time > 365*2]) + # time %in% seq(365, 2554, by = 14) # if we want to do biweekly PR reports
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#EE0800") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*3, 365*4, 365*5, 365*6 ), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

vaccine.plot.73

# ggsave(here("Figures/timeseries_vaccine_73.pdf"),
#        plot = vaccine.plot.73,
#        width = 6, height = 4.5, units = "in"
#       )
```

```{r Vaccine Area 1509 }
vaccine.plot.1509 <- ggplot(
  data = vaccine.dat[map.area == 1509 & variable == "i" & time > 365*2]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#CC006A") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*3, 365*4, 365*5, 365*6 ), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
vaccine.plot.1509

ggsave(here("Figures/timeseries_vaccine_1509.pdf"),
       plot = vaccine.plot.1509,
       width = 6, height = 4.5, units = "in"
      )
```


## Travel vaccination time series
```{r Travel Vaccine}
vaccine.means <- fread(here("data/simulation_outputs/simulations_for_figures/travel_vaccine_pr_means_time_series.csv"))
vaccine.sds <- fread(here("data/simulation_outputs/simulations_for_figures/travel_vaccine_pr_sds_time_series.csv"))

h <- melt(vaccine.means,
          id.vars = c("time", "map.area"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(vaccine.sds,
             id.vars = c("time", "map.area"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
trav.vacc.dat <- merge(h, h.sd, by = c("time", "map.area", "variable"))

trav.vacc.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("map.area", "variable", "time")]
```

```{r Travel Vaccine Area 73}
travel.vacc.plot.73 <- ggplot(
  data = trav.vacc.dat[map.area == 73 & variable == "i" & time > 35 & time < 365*5]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#EE0800") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

travel.vacc.plot.73

# ggsave(here("Figures/timeseries_travel_vaccine_73.pdf"),
#        plot = travel.vacc.plot.73,
#        width = 6, height = 4.5, units = "in"
#       )
```

```{r Vaccine Area 1509}
travel.vacc.plot.1509 <- ggplot(
  data = trav.vacc.dat[map.area == 1509 & variable == "i" & time > 35 & time < 365*5]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#CC006A") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
travel.vacc.plot.1509

# ggsave(here("Figures/timeseries_travel_vaccine_1509.pdf"),
#        plot = travel.vacc.plot.1509,
#        width = 6, height = 4.5, units = "in"
#       )
```

## Reduced importations time series
```{r Low importations}
lowimport.means <- fread(here("data/simulation_outputs/simulations_for_figures/low_import_pr_means_time_series.csv"))
lowimport.sds <- fread(here("data/simulation_outputs/simulations_for_figures/low_import_pr_sds_time_series.csv"))

h <- melt(lowimport.means,
          id.vars = c("time", "map.area"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(lowimport.sds,
             id.vars = c("time", "map.area"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
lowimport.dat <- merge(h, h.sd, by = c("time", "map.area", "variable"))

lowimport.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("map.area", "variable", "time")]
```

```{r LowImport Area 73}
lowimport.plot.73 <- ggplot(
  data = lowimport.dat[map.area == 73 & variable == "i" & time > 40 & time < 365*5]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#EE0800") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

lowimport.plot.73

# ggsave(here("Figures/timeseries_lowimport_73.pdf"),
#        plot = lowimport.plot.73,
#        width = 6, height = 4.5, units = "in"
#       )
```

```{r LowImport Area 1509}
lowimport.plot.1509 <- ggplot(
  data = lowimport.dat[map.area == 1509 & variable == "i" & time > 40 & time < 365*5]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "#CC006A") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4), labels = c(1:4),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 23),
        axis.title = element_text(size = 24),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

lowimport.plot.1509

# ggsave(here("Figures/timeseries_lowimport_1509.pdf"),
#        plot = lowimport.plot.1509,
#        width = 6, height = 4.5, units = "in"
#       )
```

# Figure 5 - Travel frequency map
```{r Travel frequency map}

trip.freq.data <- fread(here("data/clean/trip_frequency_model_estimates.csv"))

areas.inh <- merge(bi.centroids, trip.freq.data[year == 2018, .(map.area, leave.prob)], 
                   by = "map.area", all = FALSE)

example.plot <- ggplot()  +
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), 
               color = "black", fill="grey", size = 0.4) + 
    geom_path(data = ad2, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) +
    geom_path(data = ad4.sub, aes(x = long, y = lat, group = group), 
              color = "black", size = 0.4) + 
  geom_point(data = data.frame(areas.inh),
             mapping = aes(x = utm.x, y = utm.y, color = leave.prob), 
             shape = 15, size = 2.1) + 
  scale_color_gradient(name = "Travel Probability", low = "#FFFF00", high = "#FF0000") + 
  #scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4", 
  #                     breaks = c(0,1,2,3,4), 
  #                     labels = c(expression(1), 10, bquote(10^2), bquote(10^3), bquote(10^4))) +
  #scale_color_viridis(name="Log(Population)", limits=c(0, 5), option="plasma") + # set scale bar parameters
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 22),
        legend.text = element_text(size = 20),
        legend.position = c(.2, .8),
        legend.key.size = unit(.35,"inches"))
example.plot

ggsave(here("Figures/Figure_5_travel_frequency_raster.pdf"), 
       plot = example.plot,
       width = 6, height = 6, units = "in"
      )

```


# Figure 6 -Travel data plots - histograms of travel duration



First plot: how long people spend when traveling to mainland EG
```{r Trip Duration Data}
trip.dat <- fread(here("data/clean/travel_duration_data.csv"))

# 1606 people reported traveling off-island in 2018, out of 20k people surveyed
# 7202 people reported traveling off island from 2015-2018, out of 66k people surveyed

# 2111 people reported traveling on-island in 2018, out of 20k people surveyed
# 6160 people reported traveling on-island in 2015-2018, out of 66k people surveyed
```

```{r EG Trip Duration}
eg.trips.away <- ggplot() + geom_histogram(trip.dat[(destination == "off_island"),], 
                                           mapping = aes(x = nights+7), 
                          binwidth = 7,
                          color = "black", fill = "light blue") +
  # xlab("Nights spent away") + 
  # ylab("Number reporting") + 
  scale_x_continuous(name = "Nights spent away", expand = c(0,0),
                     breaks = c(30,60,90,120,150,180,210,240,270,300,330,360)) + 
  scale_y_continuous(name = "Number reporting", expand = c(0,0)) + 
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 24))
eg.trips.away
ggsave(here("Figures/Figure_6_trips_away.pdf"),
       plot = eg.trips.away,
       width = 8, height = 6, units = "in"
      )
```

```{r Trip BI duration plot }
bi.trips.away <- ggplot() + geom_histogram(trip.dat[(destination == "on_island"),], 
                                           mapping = aes(x = nights+7), 
                          binwidth = 7,
                          color = "black", fill = "#F47964") +
  # xlab("Nights spent away") + 
  # ylab("Number reporting") + 
  scale_x_continuous(name = "Nights spent away", expand = c(0,0),
                     breaks = c(30,60,90,120,150,180,210,240,270,300,330,360)) + 
  scale_y_continuous(name = "Number reporting", expand = c(0,0)) + 
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 24))
bi.trips.away

ggsave(here("Figures/Figure_6_bi_trips_away.pdf"),
       plot = bi.trips.away,
       width = 8, height = 6, units = "in"
      )
```


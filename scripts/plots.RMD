---
title: "ASTMH plots"
author: "Daniel T. Citron"
date: "11/3/2019"
output: html_document
---

Make the figures for my ASTMH poster here

```{r}
library(here)
library(data.table)
library(ggplot2)
library(viridis)
library(sp)
library(raster)
```


```{r Load data}
# population data
pop.data <- fread(here("data/clean/aggregated_2015_2018_travel_data.csv"))
pop.summary <- pop.data[year == 2018, .(areaId, ad2, pop, 
                                        trip.freq = trip.counts/n, 
                                        eg.freq = t_eg/n, 
                                        bi.freq = (trip.counts - t_eg)/n)]

# pr data
pfpr.data <- fread(here("data/clean/pfpr_draws.csv"))
pop.summary <- merge(pop.summary, pfpr.data[,.(areaId, pfpr = draw.mean)], all = FALSE)

# pr data, conditioning on travel
pfpr.travel.dat <- fread(here("data/clean/Mean_Traveler_PR_2017"))
pop.summary <- merge(pop.summary, pfpr.travel.dat[,.(areaId, pfpr.travel = pfpr)], all = FALSE)

# Load in Carlos's island outline
bi.outline <- raster::shapefile(here("data/clean/BI_maps/bioko/bioko_admin1.shp"))
#plot(bi.outline)

# Load in Carlos's centroids
bi.centroids <- raster::shapefile(here("data/raw/mapArea_centroids/mapareagrid_centroids.shp"))

# inhabited areas from the 2018 census
areas.inh <- merge(bi.centroids, pop.summary, by.x = "OBJECTID", by.y = "areaId", all = FALSE)
areas.inh <- as.data.table(areas.inh)
```

```{r A dummy variable which we can use to locate specific areaIds}
# areas.inh$dummy <- 0
# areas.inh[OBJECTID==1583, ]$dummy <- 1
# ggplot() +
#   geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.25) +
#   geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = dummy),
#              shape = 15, size = 2.1)
```

# A beautiful population map
```{r pop map}
pop.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = log10(pop)), 
             shape = 15, size = 2.1) + 
  scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4", 
                       breaks = c(0,1,2,3,4), 
                       labels = c(1, 10, bquote(10^2), bquote(10^3), bquote(10^4))) +
  #scale_color_viridis(name="Log(Population)", limits=c(0, 5), option="plasma") + # set scale bar parameters
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
pop.plot

ggsave(here("data/ASTMH/figures/population_map.pdf"),
       plot = pop.plot,
       width = 6, height = 6, units = "in"
      )
```


# A beautiful map of PfPR
```{r pfpr map}
pfpr.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = data.frame(areas.inh), mapping = aes(x = coords.x1, y = coords.x2, color = 100*pfpr), 
             shape = 15, size = 2.1) + 
  #scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4") +
  scale_color_gradient(name="PfPR (%)",
                      low="yellow", high="red", limits=c(0, 45)) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
pfpr.plot

ggsave(here("data/ASTMH/figures/pfpr_map.pdf"),
       plot = pfpr.plot,
       width = 6, height = 6, units = "in"
      )
```

# PfPR, conditioning on travel
From 2017
```{r pfpr | travel map}
# rescale 
areas.inh[, pfpr.travel.dummy := min(pfpr.travel, .45), by = "OBJECTID"]

pfpr.trav.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = 100*pfpr.travel.dummy), 
             shape = 15, size = 2.1) + 
  #scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4") +
  scale_color_gradient(name="PfPR | Travel (%)",
                      low="yellow", high="red", limits=c(0, 45)) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
pfpr.trav.plot

ggsave(here("data/ASTMH/figures/pfpr_travel_map.pdf"),
       plot = pfpr.trav.plot,
       width = 6, height = 6, units = "in"
      )
```

# Mapping travel fraction
```{r}
baseline.means <- fread(here("data/ASTMH/data/baseline_pr_means.csv"))
travelfrac.means <- fread(here("data/ASTMH/data/travelfrac_pr_means.csv"))

tf.dat <- merge(baseline.means[,.(areaId, time, i.base = i)], 
                travelfrac.means[,.(areaId, time, i.trav = i)], 
                by = c("areaId", "time"))

areas.inh[, travel.fraction := NULL]
areas.inh <- merge(areas.inh,
                   tf.dat[time > 1000, .(travel.fraction = mean(i.trav)/mean(i.base)), by = "areaId"],
                   by.x = "OBJECTID", by.y = "areaId")
areas.inh[, travel.fraction := min(travel.fraction, .5), by = "OBJECTID"]

# Make the map
travel.fraction.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = 100*travel.fraction), 
             shape = 15, size = 2.1) + 
  # scale_color_viridis(name="Travel Fraction", limits=c(0, 100), option="cividis") +
  scale_color_viridis(name="%", #"Travel Fraction (%)",
                      option="cividis", limits=c(0, 50),
                      breaks = c(0,10,20,30,40, 50),
                      labels = c("0", "10", "20", "30", "40", bquote("" >= 50))) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
travel.fraction.plot


ggsave(here("data/ASTMH/figures/travel_fraction_map.pdf"),
       plot = travel.fraction.plot,
       width = 6, height = 6, units = "in"
      )      
```

# Local Residual Fraction of Transmission
This is what happens when we turn off infections coming from off-island
```{r}
baseline.means <- fread(here("data/ASTMH/data/baseline_pr_means.csv"))
localresid.means <- fread(here("data/ASTMH/data/localresid_pr_means.csv"))

lr.dat <- merge(baseline.means[,.(areaId, time, i.base = i)], 
                localresid.means[,.(areaId, time, i.lr = i)], 
                by = c("areaId", "time"))

areas.inh[, local.resid := NULL]
areas.inh <- merge(areas.inh,
                   lr.dat[time > 1000, .(local.resid = mean(i.lr)/mean(i.base)), by = "areaId"],
                   by.x = "OBJECTID", by.y = "areaId")
#areas.inh[, local.resid := min(local.resid, .5), by = "OBJECTID"]

# Make the map
local.resid.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = 100*local.resid), 
             shape = 15, size = 2.1) + 
  # scale_color_viridis(name="Travel Fraction", limits=c(0, 100), option="cividis") +
  scale_color_viridis(name="%", #"Local Residual\nFraction (%)",
                      option = "plasma", limits=c(0, 100),
                      breaks = c(0, 25, 50, 75, 100)) + #,
                      #labels = c("0", "10", "20", "30", "40", ">=50")) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
local.resid.plot

ggsave(here("data/ASTMH/figures/local_resid_map.pdf"),
       plot = local.resid.plot,
       width = 6, height = 6, units = "in"
      )      
```

# RDT collection map:
```{r Survey coverage data}
survey.2018 <- fread(here("data/raw/2018_travel_data/mis2018travel.csv"))
survey.2018 <- dcast(survey.2018[,.(areaId, pf)], areaId ~ pf, value.var = "pf", fun.aggregate = length)
survey.2018$n <- survey.2018$no + survey.2018$yes
survey.2018[, pf := yes]
#head(survey.2018[,.(areaId, n, pf)])

survey.2015.2017 <- fread(here("data/raw/2015-2017_survey_data/summaries.csv"))
#head(survey.2015.2017[,.(areaId, n, pf)])

survey.2015.2018 <- merge(survey.2015.2017[,.(areaId, n.2015.2017 = n, pf.2015.2017 = pf)], 
                          survey.2018[,.(areaId, n.2018 = n, pf.2018 = pf)], by = "areaId" , all = TRUE)

survey.2015.2018[is.na(survey.2015.2018)] = 0
survey.2015.2018[, n := n.2015.2017 + n.2018]
survey.2015.2018[, pf := pf.2015.2017 + pf.2018]
survey.2015.2018[, pr := pf/n]
```

```{r RDT collection map}

areas.inh <- merge(areas.inh,
                   survey.2015.2018[,.(areaId, pr)],
                   by.x = "OBJECTID", by.y = "areaId")

rdt.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = 100*pr), 
             shape = 15, size = 2.1) + 
  # scale_color_viridis(name="Travel Fraction", limits=c(0, 100), option="plasma") +
  scale_color_gradient(name="2015-2018\nRDT PR (%)",
                      low="yellow", high="red",
                      limits=c(0, 50),
                      breaks = c(0,25, 50),
                      na.value = "#606060") + #,
                      #labels = c("0", "10", "20", "30", "40", ">=50")) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
rdt.plot


ggsave(here("data/ASTMH/figures/rdt_map.pdf"),
       plot = rdt.plot,
       width = 6, height = 6, units = "in"
      )      
```


# MIS coverage map - number of people sampled at each map area
```{r}
areas.inh <- merge(areas.inh,
                   survey.2015.2018[,.(areaId,n)],
                   by.x = "OBJECTID", by.y = "areaId")

coverage.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = log10(n)), 
             shape = 15, size = 2.1) + 
  # scale_color_viridis(name="Travel Fraction", limits=c(0, 100), option="plasma") +
  scale_color_gradient(name="Individuals\nSurveyed",
                      low="#FFFFFF", high="blue",
                      limits = c(0, 4),
                      breaks = c(0, 1 ,2, 3,4),
                      labels = c(1, 10, bquote(10^2), bquote(10^3), bquote(10^4)),
                      na.value = "#606060") + #,
                      #labels = c("0", "10", "20", "30", "40", ">=50")) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
coverage.plot

ggsave(here("data/ASTMH/figures/MIS_coverage_map.pdf"),
       plot = coverage.plot,
       width = 6, height = 6, units = "in"
      )      
```


A map of the frequency of travel:
```{r Total Travel Frequency Map}
trav.freq.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = trip.freq*100), 
             shape = 15, size = 2.1) + 
  scale_color_viridis(name="%", #"Proportion who Traveled (%)",
                      option = "plasma", limits=c(0, 100),
                      breaks = c(0, 25, 50, 75, 100)) + #,
  #scale_color_viridis(name="Log(Population)", limits=c(0, 5), option="plasma") + # set scale bar parameters
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
#trav.freq.plot
```

```{r EG Travel Frequency Map}
trav.freq.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = eg.freq*100), 
             shape = 15, size = 2.1) + 
  scale_color_viridis(name="%", #"Proportion who Traveled (%)",
                      option = "plasma", limits=c(0, 50),
                      breaks = c(0, 25, 50, 75, 100)) + #,
  #scale_color_viridis(name="Log(Population)", limits=c(0, 5), option="plasma") + # set scale bar parameters
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
#trav.freq.plot
```

```{r EG Travel Frequency Map}
trav.freq.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = bi.freq*100), 
             shape = 15, size = 2.1) + 
  scale_color_viridis(name="%", #"Proportion who Traveled (%)",
                      option = "plasma", limits=c(0, 50),
                      breaks = c(0, 25, 50, 75, 100)) + #,
  #scale_color_viridis(name="Log(Population)", limits=c(0, 5), option="plasma") + # set scale bar parameters
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
#trav.freq.plot
```


Need maps of attack rate, but to do this we need to first compute the TaR matrix and work backward from the median draw of PR
```{r Attack Rate Calculation}
# travel destination selection model
trip.dest.data <- fread(here("data/clean/negative_binomial_predictions_by_destination_region.csv"))

# travel duration
trip.duration.eg <- 1/0.04713604 # rate of return from mainland eg to bioko
trip.duration.bi <- 1/0.09670302 # rate of return from trips on bioko

source(here("scripts/region_to_areaId_mapping.R"))
# convert the trip.dest.data into a matrix
trip.dest.mat <- as.matrix(trip.dest.data[year == 2018 & draw == "draw.mean", .(t_eg, ti_ban, ti_lub, ti_mal, ti_mok, ti_ria, ti_ure)])
trip.dest.mat <- rbind(trip.dest.mat, matrix(c(1,0,0,0,0,0,0), ncol = 7))
# take the matrix product of trip.dest.mat with the region-to-pixel matrix toget pixel-to-pixel:
movement.matrix <- trip.dest.mat %*% reg.2.pixel

# NB: the movement matrix is the probability of going from each areaId to each other areaId;
# we need to combine it with the other travel data to obtain the full TaR matrix
TaR.matrix <- diag(1, nrow = 242, ncol = 242)
# vector of trip durations across the island and off-island
trip.duration <- c(rep(trip.duration.bi, 241), trip.duration.eg)
# vector of frequencies at which people leave home
# where we divide by 56 to transform the probability of leaving into 
# the frequency of leaving during the study period
trip.freq <- c((trip.freq.data[year == 2018]$draw.mean)/56, 1)
for (i in 1:242){
  TaR.matrix[i,] <- (movement.matrix[i,]*trip.duration)/(sum(movement.matrix[i,]*trip.duration) + 1/trip.freq[i])
  TaR.matrix[i,i] <- 1 - sum(TaR.matrix[i,])
  TaR.matrix[i,] <- TaR.matrix[i,]/sum(TaR.matrix[i,])
}

pfpr.input <- c(pop.summary$pfpr, 0.43)

a = 0.3*0.9
b = 0.55
c = 0.15
r = 1./200 # rate at which people become cured
eta = 1./30 # rate at which prophylaxis wears off
p = 0.9 # fraction of surviving mosquitoes
g = 1 - p # fraction of dying mosquitoes
peip = p^11 # fraction of mosquitoes who survive incubation period
FeverPf = 0.1116336
TreatPf = 0.602
rho = FeverPf*TreatPf # probability of clearing infection through treatment cascade

odds.vector <- r/(1-rho)*pfpr.input/(1-(1+rho*r/eta/(1-rho))*pfpr.input)
h.FOI <- MASS::ginv(TaR.matrix) %*% odds.vector
h.FOI[which(h.FOI < 0)] <- 0

# And lastly we add this to our areas.inh data
areas.inh$attack.rate <- h.FOI[1:241]
areas.inh[attack.rate > .0025]$attack.rate <- .0025 
```

```{r Attack Rate Plots}
ar.figure <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = areas.inh, mapping = aes(x = coords.x1, y = coords.x2, color = attack.rate), 
             shape = 15, size = 2.1) + 
  # scale_color_viridis(name="Travel Fraction", limits=c(0, 100), option="cividis") +
  scale_color_viridis(name=" ", #"Travel Fraction (%)",
                      option="inferno", limits=c(0, .003),
                      breaks = c(0,.003),
                      labels = c("Low", "High")) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.2, .8),
        legend.key.size = unit(.35,"inches"))
ar.figure


ggsave(here("data/ASTMH/figures/attack_rate_map.pdf"),
       plot = ar.figure,
       width = 6, height = 6, units = "in"
      )      
```


The end of the maps

# Now we create some time series plots

First, load in all of the data
# Baseline
```{r Baseline}
baseline.means <- fread(here("data/ASTMH/data/baseline_pr_means_1000.csv"))
baseline.sds <- fread(here("data/ASTMH/data/baseline_pr_sds_1000.csv"))

h <- melt(baseline.means,
          id.vars = c("time", "areaId"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(baseline.sds,
             id.vars = c("time", "areaId"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
baseline.dat <- merge(h, h.sd, by = c("time", "areaId", "variable"))

baseline.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("areaId", "variable", "time")]

```

# Vaccine
```{r Vaccine}
vaccine.means <- fread(here("data/ASTMH/data/vaccine_pr_means_1000.csv"))
vaccine.sds <- fread(here("data/ASTMH/data/vaccine_pr_sds_1000.csv"))

h <- melt(vaccine.means,
          id.vars = c("time", "areaId"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(vaccine.sds,
             id.vars = c("time", "areaId"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
vaccine.dat <- merge(h, h.sd, by = c("time", "areaId", "variable"))

vaccine.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("areaId", "variable", "time")]
```

# Reduced importations
```{r Low importations}
lowimport.means <- fread(here("data/ASTMH/data/lowimport_trueICs_pr_means_1000.csv"))
lowimport.sds <- fread(here("data/ASTMH/data/lowimport_trueICs_pr_sds_1000.csv"))

h <- melt(lowimport.means,
          id.vars = c("time", "areaId"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(lowimport.sds,
             id.vars = c("time", "areaId"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
lowimport.dat <- merge(h, h.sd, by = c("time", "areaId", "variable"))

lowimport.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("areaId", "variable", "time")]
```

# Zero importations
```{r Zero importations}
localresid.means <- fread(here("data/ASTMH/data/localresid_pr_means.csv"))
localresid.sds <- fread(here("data/ASTMH/data/localresid_pr_sds.csv"))

h <- melt(localresid.means,
          id.vars = c("time", "areaId"), 
          measure.vars = c("s","i","p"),
          value.name = "fraction")
h.sd <- melt(localresid.sds,
             id.vars = c("time", "areaId"), 
             measure.vars = c("s","i","p"),
             value.name = "fraction.sd")
localresid.dat <- merge(h, h.sd, by = c("time", "areaId", "variable"))

localresid.dat[, lower.bound := max(fraction - fraction.sd, 0), by = c("areaId", "variable", "time")]
```

# Plots for areaId 335

```{r Area 335 plots - Baseline}
baseline.plot.335 <- ggplot(
  data = baseline.dat[areaId == 335 & variable == "i" & time > 365]) + # time %in% seq(365, 2554, by = 14) # if we want to do biweekly PR reports
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*2, 365*3, 365*4, 365*5, 365*6 ), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 20),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

baseline.plot.335

ggsave(here("data/ASTMH/figures/baseline_timeseries_335.pdf"),
       plot = baseline.plot.335,
       width = 4, height = 3, units = "in"
      )
```

```{r Area 335 plots - Low Importions}
lowimport.plot.335 <- ggplot(
  data = lowimport.dat[areaId == 335 & variable == "i" & time > 50 & time < 365*6]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 22),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

lowimport.plot.335

ggsave(here("data/ASTMH/figures/lowimport_timeseries_335.pdf"),
       plot = lowimport.plot.335,
       width = 4, height = 3, units = "in"
      )
```

```{r Area 335 plots - Local Residual}

local.resid.plot.335 <- ggplot(
  data = localresid.dat[areaId == 335 & variable == "i" & time < 6*365 & time > 50]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

ggsave(here("data/ASTMH/figures/local_residual_timeseries_335.pdf"),
       plot = local.resid.plot.335,
       width = 6, height = 6, units = "in"
      )

local.resid.plot.335
```

```{r Area 335 plots - Vaccines}
vaccine.plot.335 <- ggplot(
  data = vaccine.dat[areaId == 335 & variable == "i" & time > 365]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*2, 365*3, 365*4, 365*5, 365*6 ), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.105),
                     breaks = c(0,.05,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 22),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

vaccine.plot.335

ggsave(here("data/ASTMH/figures/vaccine_timeseries_335.pdf"),
       plot = vaccine.plot.335,
       width = 4, height = 3, units = "in"
      )
```

# Plots for areaId 2694

```{r Area 2694 plots - Baseline}
baseline.plot.2694 <- ggplot(
  data = baseline.dat[areaId == 2694 & variable == "i" & time > 365]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*2, 365*3, 365*4, 365*5, 365*6), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = 1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 22),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
baseline.plot.2694

ggsave(here("data/ASTMH/figures/baseline_timeseries_2694.pdf"),
       plot = baseline.plot.2694,
       width = 4, height = 3, units = "in"
      )
```

```{r Area 2694 plots - Low Importions}
lowimport.plot.2694 <- ggplot(
  data = lowimport.dat[areaId == 2694 & variable == "i" & time < 6*365 & time > 50]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 22),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

lowimport.plot.2694

ggsave(here("data/ASTMH/figures/lowimport_timeseries_2694.pdf"),
       plot = lowimport.plot.2694,
       width = 4, height = 3, units = "in"
      )
```

```{r Area 2694 plots - Local Residual}

local.resid.plot.2694 <- ggplot(
  data = localresid.dat[areaId == 2694 & variable == "i" & time < 6*365 & time > 50]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

ggsave(here("data/ASTMH/figures/local_residual_timeseries_2694.pdf"),
       plot = local.resid.plot.2694,
       width = 6, height = 6, units = "in"
      )

local.resid.plot.2694
```

```{r Area 2694 plots - Vaccines}
vaccine.plot.2694 <- ggplot(
  data = vaccine.dat[areaId == 2694 & variable == "i" & time > 365]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365*2, 365*3, 365*4, 365*5, 365*6), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.31)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 22),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))

vaccine.plot.2694

ggsave(here("data/ASTMH/figures/vaccine_timeseries_2694.pdf"),
       plot = vaccine.plot.2694,
       width = 4, height = 3, units = "in"
      )
```

# Code Graveyard

```{r}
dummy <- merge(lowimport.dat, pop.summary[,.(areaId, ad2)], by = "areaId")

ggplot(data = dummy[ad2 == "Malabo" & variable == "i" & time < 6*365] ) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .2) +
  facet_wrap(~areaId)
```

```{r}
ggplot(data = dummy[ad2 == "Riaba" & variable == "i" & time < 6*365] ) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .2) +
  facet_wrap(~areaId)
```

```{r}
ggplot(data = dummy[ad2 == "Luba" & variable == "i" & time < 6*365] ) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .2) +
  facet_wrap(~areaId)
```


```{r Plot Low Importations - area in Malabo with high importations}
ggplot(data = lowimport.dat[areaId == 335 & variable == "i" & time < 365*6]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.3)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```

```{r Plot Zero Importations - area}



ggplot(data = localresid.dat[areaId == 502 & variable == "i" & time < 6*365]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.5)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```

```{r Plot Vaccine data - area 335}
ggplot(data = vaccine.dat[areaId == 335 & variable == "i"]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.1)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```

```{r Plot Vaccine data - area 502}
ggplot(data = vaccine.dat[areaId == 502 & variable == "i"]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.5)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```


```{r Plot Baseline data}
ggplot(data = baseline.dat[areaId == 502 & variable == "i"]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.5)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```





```{r Plot Low Importations - Basupu}
ggplot(data = lowimport.dat[areaId == 502 & variable == "i" & time < 6*365]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.5)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```

```{r Plot Vaccine data - Basupu}
ggplot(data = vaccine.dat[areaId == 502 & variable == "i"]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.4)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```


```{r Plot Low Importations - Riaba}
ggplot(data = lowimport.dat[areaId == 2573 & variable == "i" & time < 6*365]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.5)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```

```{r Plot Vaccine data - Riaba}
ggplot(data = vaccine.dat[areaId == 2573 & variable == "i"]) + 
  geom_errorbar(mapping = aes(x = time, 
                              ymin = lower.bound,
                              ymax = fraction + fraction.sd), 
                alpha = .5, color = "red") + 
  scale_x_continuous(name = "Time (Years)", 
                     breaks = c(365, 365*2, 365*3, 365*4, 365*5), labels = c(1:5),
                     expand = c(0,0)) + 
  scale_y_continuous(name = "Prevalence", 
                     expand = c(0,0),
                     limits = c(0,.4)) + #ylab("Prevalence") +
  geom_point(mapping = aes(x = time, y = fraction), color = "black", shape = 16, size = .1) +
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        panel.grid = element_line(color = NULL),
        legend.position = c(.8, .8))
```


# Plots for BIMEP meeting

First plot: how long people spend when traveling to mainland EG
```{r Trip Duration Data}
eg.dat <- fread(here("data/raw/2018_travel_data/trips_to_EG.csv"))
eg.dat <- eg.dat[!is.na(nights)]

# 1606 people reported traveling off-island in 2018, out of 20k people surveyed
# 7202 people reported traveling off island from 2015-2018, out of 66k people surveyed

# 2111 people reported traveling on-island in 2018, out of 20k people surveyed
# 6160 people reported traveling on-island in 2015-2018, out of 66k people surveyed

```

```{r EG Trip Duration}
eg.trips.away <- ggplot() + geom_histogram(eg.dat, mapping = aes(x = nights+7), 
                          binwidth = 7,
                          color = "black", fill = "light blue") +
  # xlab("Nights spent away") + 
  # ylab("Number reporting") + 
  scale_x_continuous(name = "Nights spent away", expand = c(0,0),
                     breaks = c(30,60,90,120,150,180,210,240,270,300,330,360)) + 
  scale_y_continuous(name = "Number reporting", expand = c(0,0)) + 
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 24))
eg.trips.away
ggsave(here("data/ASTMH/figures/eg_trips_away.pdf"),
       plot = eg.trips.away,
       width = 8, height = 6, units = "in"
      )
```

Second plot: how long people spend when traveling on BI
```{r Trip BI data }
bi.dat <- fread(here("data/raw/2018_travel_data/trips_on_BI.csv"))
bi.dat <- bi.dat[!is.na(nights)]
```

```{r Trip BI duration plot }
bi.trips.away <- ggplot() + geom_histogram(bi.dat, mapping = aes(x = nights+7), 
                          binwidth = 7,
                          color = "black", fill = "#F47964") +
  # xlab("Nights spent away") + 
  # ylab("Number reporting") + 
  scale_x_continuous(name = "Nights spent away", expand = c(0,0),
                     breaks = c(30,60,90,120,150,180,210,240,270,300,330,360)) + 
  scale_y_continuous(name = "Number reporting", expand = c(0,0)) + 
  theme(panel.background = element_rect(fill = "white", colour = "white"),
        axis.line = element_line(color = "black", size = 1),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 24))
bi.trips.away
ggsave(here("data/ASTMH/figures/bi_trips_away.pdf"),
       plot = bi.trips.away,
       width = 8, height = 6, units = "in"
      )
```


# Post-presentation
Immo had a question of overall reduction in prevalence, island-wide

```{r Baseline: how many cases are there?}
# Baseline:
# total number of cases on-island, divided by the total number of people on-island
# number of cases for each area-id is computed as PR_i * pop_i
baseline.cases <- merge(pop.data[year == 2018,.(areaId, pop)], pfpr.data[,.(areaId, draw.mean)], by = "areaId")

baseline.cases[, case.no := pop*draw.mean]

sum(baseline.cases$case.no)/sum(baseline.cases$pop)
```

```{r Island-wide prevalence reduction after 50%}
# When we reduce incidence off-island by 50%
# Again, count the average number of infected people in each location

lowimport <- fread(here("data/ASTMH/data/lowimport_pr_means.csv"))

lowimport <- lowimport[,.(areaId, time, pop, i, case.no = pop*i)]

lowimport[time > 1000, .(mean.case.no = mean(case.no)), by = "areaId"]

sum(lowimport[time > 1000, .(mean.case.no = mean(case.no)), by = "areaId"]$mean.case.no)

sum(lowimport[time > 1000, .(mean.case.no = mean(case.no)), by = "areaId"]$mean.case.no)/sum(baseline.cases$pop)

```

```{r Island-wide prevalence reduction after 100%}

noimport <- fread(here("data/ASTMH/data/localresid_pr_means.csv"))

noimport <- noimport[, .(areaId, time, pop, i, case.no = pop*i)]

noimport[time > 1000, .(mean.case.no = mean(case.no)), by = "areaId"]

sum(noimport[time > 1000, .(mean.case.no = mean(case.no)), by = "areaId"]$mean.case.no)

sum(noimport[time > 1000, .(mean.case.no = mean(case.no)), by = "areaId"]$mean.case.no)/sum(baseline.cases$pop)
```


Now we make a map, similar to the PR map:
```{r Low Importation rate}

areas.inh$dummy <- lowimport[time > 1000, .(mean(i)), by = "areaId"]$V1

pfpr.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = data.frame(areas.inh), mapping = aes(x = coords.x1, y = coords.x2, color = 100*dummy), 
             shape = 15, size = 2.1) + 
  #scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4") +
  scale_color_gradient(name="PfPR (%)",
                      low="yellow", high="red", limits=c(0, 40)) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
pfpr.plot

ggsave(here("data/ASTMH/figures/pfpr_map_reduced_importations.pdf"),
       plot = pfpr.plot,
       width = 6, height = 6, units = "in"
      )
```



```{r No Importation rate}

areas.inh$dummy <- noimport[time > 1000, .(mean(i)), by = "areaId"]$V1

pfpr.plot <- ggplot() + 
  geom_polygon(data = bi.outline, aes(x = long, y = lat, group = group), color = "black", fill="grey", size = 0.4) + 
  geom_point(data = data.frame(areas.inh), mapping = aes(x = coords.x1, y = coords.x2, color = 100*dummy), 
             shape = 15, size = 2.1) + 
  #scale_color_gradient(name = "Population", low = "#FFFFFF", high = "#5519C4") +
  scale_color_gradient(name="PfPR (%)",
                      low="yellow", high="red", limits=c(0, 40)) +
  # move the scale bar
  coord_fixed() + # aspect ratio
  theme(aspect.ratio = 1, 
        panel.background = element_rect(fill = "white", colour = "white"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.title = element_text(size = 24),
        legend.text = element_text(size = 22),
        legend.position = c(.25, .75),
        legend.key.size = unit(.35,"inches"))
pfpr.plot

ggsave(here("data/ASTMH/figures/pfpr_map_no_importations.pdf"),
       plot = pfpr.plot,
       width = 6, height = 6, units = "in"
      )
```
